define(["jquery","jquery/fileupload","jquery/qtip","ekyna-form/file-picker","ekyna-string"],function(a){"use strict";return a.fn.renameWidget=function(b){return b=a.extend({file:null},b),this.each(function(){var c=a(this),d=b.file,e="",f=c.val();c.stripExtension=function(){if(0!=e.length){var a=c.val().lastIndexOf(e);a>0&&c.val(c.val().substring(0,a))}},c.appendExtension=function(){c.val(c.val()+e)},c.normalize=function(){c.stripExtension();var a=c.val().trim().toLowerCase().urlize();a.length>0?(c.val(a),c.appendExtension()):c.val(f)},c.getExtension=function(){var a=c.val().fileExtension();a.length>0&&(e="."+a),c.normalize()},c.getExtension(),null!==d&&1==d.length&&(c.updateFromFile=function(){var a=d.val();if(0<a.length){0==c.val().length&&c.val(a.fileName());var b=a.fileName().fileExtension();b.length>0?(c.stripExtension(),e="."+b,c.normalize()):c.getExtension()}else c.val(f),c.getExtension()},d.bind("change",c.updateFromFile),c.updateFromFile()),c.bind("focus",function(){c.stripExtension()}),c.bind("blur",c.normalize)}),this},a.fn.uploadWidget=function(){return this.each(function(){var b=a(this),c=b.find(".file-picker"),d=c.find("input:file");b.find(".file-rename").renameWidget({file:d});var e=b.find('input[data-target="'+d.attr("id")+'"]');if(1==e.length){var f=null,g=d.closest("form"),h=b.find("div#"+d.attr("id")+"_progress"),i=g.find("[type=submit]");0==i.length&&(i=g.closest(".modal-content").find("button#submit")),c.on("ekyna.upload.clear",function(){e.val(null),f&&(f.abort(),f=null)}),d.fileupload().bind("fileuploadadd",function(a,b){f&&f.abort(),f=b.submit()}).bind("fileuploadsubmit",function(){var a=g.data("uploadCount")||0;a++,i.prop("disabled",!0),g.data("uploadCount",a),h.fadeIn()}).bind("fileuploadalways",function(){var b=g.data("uploadCount")||0;b--,g.data("uploadCount",b),0>=b&&i.prop("disabled",!1),h.fadeOut(function(){a(this).find(".progress-bar").css({width:"0%"}).attr("aria-valuenow",0)}),f=null}).bind("fileuploaddone",function(a,b){var c=JSON.parse(b.result);c.hasOwnProperty("upload_key")&&e.val(c.upload_key)}).bind("fileuploadprogress",function(a,b){if(b._progress){var c=parseInt(b._progress.loaded/b._progress.total*100,10);h.find(".progress-bar").css({width:c+"%"}).attr("aria-valuenow",c)}}),g.bind("submit",function(a){var b=g.data("uploadCount")||0;if(0<b)return i.qtip({content:"Veuillez patienter pendant le téléchargement de vos fichiers&hellip;",style:{classes:"qtip-bootstrap"},hide:{fixed:!0,delay:300},position:{my:"bottom center",at:"top center",target:"mouse",adjust:{mouse:!1,scroll:!1}}}),a.preventDefault(),!1})}}),this},{init:function(a){a.uploadWidget()}}});