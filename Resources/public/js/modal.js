define(["require","jquery","bootstrap/dialog"],function(a,b,c){"use strict";function d(a){var b="html",c=a.getResponseHeader("content-type");return/json/.test(c)?b="json":/xml/.test(c)&&(b="xml"),b}var e=function(){this.dialog=new c,this.form=null;var a=this;a.dialog.onShow(function(){var c=b.Event("ekyna.modal.show");c.modal=a,b(a).trigger(c)}),a.dialog.onShown(function(){var c=b.Event("ekyna.modal.shown");c.modal=a,b(a).trigger(c)}),a.dialog.onHide(function(){var c=b.Event("ekyna.modal.hide");return c.modal=a,b(a).trigger(c),!c.isDefaultPrevented()&&void(a.form&&(a.form.destroy(),a.form=null))}),a.dialog.onHidden(function(){var c=b.Event("ekyna.modal.hidden");c.modal=a,b(a).trigger(c)})};return e.prototype={constructor:e,load:function(a){a.cache=!1;var c=this,d=b.ajax(a);return d.done(function(a,b,d){c.handleResponse(a,b,d)}),d.fail(function(){console.log("Failed to load modal.");var a=b.Event("ekyna.modal.load_fail");b(c).trigger(a)}),d},handleResponse:function(c,e,f){var g,h=this,i=d(f);if(h.form&&(h.form.destroy(),h.form=null),g=b.Event("ekyna.modal.response"),g.modal=h,g.contentType=i,g.content=c,b(h).trigger(g),g.isDefaultPrevented())return h.close();if("xml"!=i)return this;var j=b(c),k=j.find("content");if(!(k.size()>0))return this;i=k.attr("type"),g=b.Event("ekyna.modal.content"),g.modal=h,g.contentType=i;var l=k.text();if("data"===i)return g.content=JSON.parse(l),b(h).trigger(g),h.close();var m=b(l);if(g.content=m,b(h).trigger(g),g.isDefaultPrevented())return h.close();h.dialog.setMessage(m),"form"===i&&(b(h.dialog.getModal()).removeAttr("tabindex"),b(h).one("ekyna.modal.shown",function(){a(["ekyna-form"],function(a){h.form=a.create(m),h.form.init(h.dialog.getModal()),h.form.getElement().on("submit",function(a){a.preventDefault(),h.dialog.enableButtons(!1);var b=h.dialog.getButton("submit");return b&&b.spin(),h.form.save(),setTimeout(function(){h.form.getElement().ajaxSubmit({success:function(a,b,c){h.handleResponse(a,b,c)}})},100),!1})})}));var n=j.find("title");n.size()>0&&h.dialog.setTitle(n.text());var o=JSON.parse(j.find("config").text());o.type&&h.dialog.setType(o.type),o.size&&h.dialog.setSize(o.size);var p=j.find("buttons");if(p.size()>0){var q=JSON.parse(p.text(),function(a,b){return b&&"string"==typeof b&&0===b.indexOf("function")?new Function("return "+b)():b});b(q).each(function(a,c){"function"!=typeof c.action&&("close"==c.id?c.action=function(a){a.enableButtons(!1),a.close()}:c.action=function(a){a.enableButtons(!1);var d=b.Event("ekyna.modal.button_click");d.modal=h,d.buttonId=c.id,b(h).trigger(d),h.form&&"submit"==c.id&&!d.isDefaultPrevented()&&h.form.getElement().submit()})}),h.dialog.setButtons(q)}else h.dialog.setButtons([]);return h.dialog.isOpened()||h.dialog.open(),this},close:function(){return this.dialog.isOpened()&&this.dialog.close(),this},getDialog:function(){return this.dialog}},b(document).on("click",'button[data-modal="true"], a[data-modal="true"], [data-modal="true"] > a',function(a){a.preventDefault();var c=new e;return c.load({url:b(this).attr("href")}),!1}),e});